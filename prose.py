import streamlit as st
import anthropic
from io import StringIO
import json

# Примеры обвинительных речей остаются без изменений
SPEECH_EXAMPLES = [
    """
Уважаемый суд!

Сегодня мы рассматриваем дело по обвинению гражданина Колесникова Максима Анатольевича в совершении преступления, предусмотренного статьей 188 частью 3 пунктом 2 Уголовного кодекса Республики Казахстан.

В ходе судебного следствия установлено, что в период с 27.05.2022 по 09.06.2022 Колесников М.А., действуя группой лиц по предварительному сговору с Жанболат Ш.Н. и Нишанбаев Н.А., совершил неоднократное тайное хищение денежных средств из банкомата АО "Каспи банк", расположенного по адресу: г. Шымкент, пр. Женис, 25.

Преступными действиями обвиняемых причинен материальный ущерб АО "Каспи банк" на общую сумму 6 990 500 тенге.

Вина подсудимого полностью доказана материалами дела, в том числе показаниями потерпевшего, признательными показаниями самого подсудимого, свидетельскими показаниями, а также вещественными доказательствами, включая видеозаписи с камер наблюдения банкомата.

Действия Колесникова М.А. правильно квалифицированы по статье 188 части 3 пункту 2 УК РК как кража, то есть тайное хищение чужого имущества, совершенное неоднократно группой лиц по предварительному сговору.

Учитывая тяжесть совершенного преступления, его продолжительный характер, значительный материальный ущерб, а также то, что преступление совершено в составе группы, прошу суд назначить Колесникову М.А. наказание в виде 4 лет лишения свободы с отбыванием в учреждении уголовно-исполнительной системы средней безопасности.

Также прошу суд удовлетворить гражданский иск потерпевшего о возмещении материального ущерба в полном объеме и взыскать с подсудимого в пользу АО "Каспи банк" сумму 6 990 500 тенге.
    """,
    """
Уважаемый суд!

Сегодня мы завершаем рассмотрение уголовного дела в отношении Балкенова Ерлана Ехласовича, обвиняемого в совершении преступлений, предусмотренных статьями 188 частью 3 пунктом 3, 120 частью 1, 188 частью 3 пунктами 2, 3 Уголовного кодекса Республики Казахстан.

В ходе судебного разбирательства установлено, что Балкенов Е.Е. совершил ряд тяжких преступлений против собственности и личности граждан.

Вина подсудимого подтверждается совокупностью доказательств, исследованных в суде, включая показания потерпевших, заключения экспертиз, протоколы следственных действий и другие материалы дела.

Действия Балкенова Е.Е. правильно квалифицированы по статьям 188 части 3 пункту 3, 120 части 1, 188 части 3 пунктам 2, 3 УК РК.

Учитывая тяжесть и общественную опасность совершенных преступлений, отсутствие смягчающих обстоятельств, прошу суд назначить Балкенову Е.Е. наказание:
- по статье 188 части 3 пунктам 2, 3 УК РК в виде лишения свободы сроком на 3 года;
- по статье 120 части 1 УК РК в виде лишения свободы сроком на 6 лет.

На основании статьи 58 части 3 УК РК, путем частичного сложения наказаний, прошу окончательно назначить Балкенову Е.Е. 7 лет лишения свободы с отбыванием наказания в учреждении уголовно-исполнительной системы средней безопасности.

Также прошу суд удовлетворить гражданские иски потерпевших и взыскать с подсудимого в пользу потерпевших суммы причиненного материального ущерба.
    """
]

# Функция для получения API ключа
def get_api_key():
    input_key = st.text_input("Введите API ключ Anthropic (Claude)", type="password")
    return input_key

# Инициализация клиента Claude
@st.cache_resource
def init_claude_client(api_key):
    return anthropic.Anthropic(api_key=api_key)

def extract_and_analyze_act(client, text):
    prompt = f"""
    Проанализируйте следующий обвинительный акт и извлеките из него ключевую информацию:

    {text}

    Пожалуйста, предоставьте следующую информацию в формате JSON:
    1. ФИО подозреваемого
    2. Дата преступления
    3. Статья обвинения
    4. Информация о предыдущих судимостях
    5. Краткое описание обстоятельств дела
    6. Любые смягчающие обстоятельства
    7. Любые отягчающие обстоятельства
    8. Сумма ущерба (если применимо)
    """

    response = client.messages.create(
        model="claude-3-sonnet-20240229",
        max_tokens=1024,
        messages=[
            {"role": "user", "content": prompt}
        ]
    )

    return json.loads(response.content[0].text)

def generate_speech_claude(client, data, examples):
    examples_text = "\n\n".join(examples)
    prompt = f"""
    На основе следующей информации, извлеченной из обвинительного акта, сгенерируйте обвинительную речь прокурора:

    {json.dumps(data, ensure_ascii=False, indent=2)}

    Используйте следующие примеры обвинительных речей как образец стиля и структуры:

    {examples_text}

    Ваша речь должна точно следовать структуре и стилю примера, включая:
    1. Вступительное слово с указанием ФИО подсудимого, статьи обвинения и даты преступления
    2. Подробное изложение фактов дела с указанием конкретных дат, сумм и обстоятельств
    3. Анализ доказательств с перечислением конкретных доказательств вины
    4. Четкую юридическую квалификацию деяния
    5. Обоснование предлагаемого наказания с учетом смягчающих и отягчающих обстоятельств
    6. Заключительную часть с конкретным запросом о сроке и виде наказания, а также о возмещении ущерба

    Обязательно укажите конкретный запрашиваемый срок наказания в годах и месяцах, основываясь на санкции соответствующей статьи УК РК и обстоятельствах дела.

    Используйте формальный юридический язык и структуру, характерную для обвинительной речи в суде Казахстана.
    """

    response = client.messages.create(
        model="claude-3-sonnet-20240229",
        max_tokens=4096,
        messages=[
            {"role": "user", "content": prompt}
        ]
    )

    return response.content[0].text

st.title("Генератор обвинительной речи на основе обвинительного акта")

api_key = get_api_key()

if api_key:
    claude_client = init_claude_client(api_key)

    uploaded_file = st.file_uploader("Загрузите обвинительный акт", type="txt")

    if uploaded_file is not None:
        stringio = StringIO(uploaded_file.getvalue().decode("utf-8"))
        act_text = stringio.read()
        
        with st.spinner('Анализ обвинительного акта...'):
            extracted_info = extract_and_analyze_act(claude_client, act_text)
        
        st.subheader("Извлеченная информация")
        st.json(extracted_info)
        
        if st.button("Сгенерировать речь"):
            with st.spinner('Генерация речи...'):
                speech = generate_speech_claude(claude_client, extracted_info, SPEECH_EXAMPLES)
            
            st.subheader("Сгенерированная обвинительная речь")
            st.text_area("Речь", speech, height=400)

    st.markdown("""
        ### Инструкция по использованию:
        1. Введите API ключ Anthropic (Claude)
        2. Загрузите файл обвинительного акта в формате .txt
        3. После загрузки будет проведен анализ и извлечение ключевой информации
        4. Проверьте извлеченную информацию
        5. Нажмите кнопку "Сгенерировать речь" для создания обвинительной речи
    """)
else:
    st.warning("Пожалуйста, введите API ключ Anthropic (Claude) для начала работы.")
